#!/bin/bash

# ONEDRIVE auto sync for linux -> add to crontab
# onedrive for linux: https://github.com/abraunegg/onedrive

LOGFILE="/home/m1tus/.log/onedrive-sync.log"
LOGDIR=$(dirname $LOGFILE)

ONEDRIVE_ARGS="--sync"
if [ $# -gt 0 ]; then
    ONEDRIVE_ARGS="$@"
fi

# syncs onedrive
function exec_sync() {
    local TIMESTAMP=$(date '+%d-%m-%Y %H:%M:%S')
    # outputs the time, host and user executing this script to the logfile
    echo "$TIMESTAMP $(hostname)" >> "$LOGFILE"
    if [ -t 1 ]; then
        onedrive "$ONEDRIVE_ARGS"
    else
        onedrive "$ONEDRIVE_ARGS" 2>&1 >/dev/null
    fi
}

function notify_user() {
    local message="$1"
    local body="$2"

    # Specify the user explicitly
    local user="m1tus"

    # Get the user's UID
    local uid=$(id -u $user)

    # Construct the DBUS_SESSION_BUS_ADDRESS
    local dbus_address="unix:path=/run/user/$uid/bus"

    # Send the notification
    sudo -u $user DISPLAY=:0 DBUS_SESSION_BUS_ADDRESS=$dbus_address notify-send "$message" "$body"
}

# Checks for .log dir
if [ ! -d "$LOGDIR" ]; then
    echo "Directory $LOGDIR does not exist"
    exit 1
fi

# Attempts to create LOGFILE
touch "$LOGFILE"

if [ $? -ne 0 ]; then
    echo "Log file could not be created. Check permissions"
    exit 1
fi

# Sync
exec_sync

if [ $? -ne 0 ]; then
    notify_user "OneDrive Update Failed" "KO"
fi

